
var TILE_SIZE=256;function RichMarker(b){var a=b||{};this.ready_=false;this.dragging_=false;if(b.visible==undefined){b.visible=true}if(b.shadow==undefined){b.shadow="7px -3px 5px rgba(88,88,88,0.7)"}if(b.anchor==undefined){b.anchor=RichMarkerPosition.BOTTOM}this.setValues(a)}RichMarker.prototype=new google.maps.OverlayView();window.RichMarker=RichMarker;RichMarker.prototype.getVisible=function(){return(this.get("visible"))};RichMarker.prototype.getVisible=RichMarker.prototype.getVisible;RichMarker.prototype.setVisible=function(a){this.set("visible",a)};RichMarker.prototype.setVisible=RichMarker.prototype.setVisible;RichMarker.prototype.visible_changed=function(){if(this.ready_){this.markerWrapper_.style.display=this.getVisible()?"":"none";this.draw()}};RichMarker.prototype.visible_changed=RichMarker.prototype.visible_changed;RichMarker.prototype.setFlat=function(a){this.set("flat",!!a)};RichMarker.prototype.setFlat=RichMarker.prototype.setFlat;RichMarker.prototype.getFlat=function(){return(this.get("flat"))};RichMarker.prototype.getFlat=RichMarker.prototype.getFlat;RichMarker.prototype.getWidth=function(){return(this.get("width"))};RichMarker.prototype.getWidth=RichMarker.prototype.getWidth;RichMarker.prototype.getHeight=function(){return(this.get("height"))};RichMarker.prototype.getHeight=RichMarker.prototype.getHeight;RichMarker.prototype.setShadow=function(a){this.set("shadow",a);this.flat_changed()};RichMarker.prototype.setShadow=RichMarker.prototype.setShadow;RichMarker.prototype.getShadow=function(){return(this.get("shadow"))};RichMarker.prototype.getShadow=RichMarker.prototype.getShadow;RichMarker.prototype.flat_changed=function(){if(!this.ready_){return}this.markerWrapper_.style.boxShadow=this.markerWrapper_.style.webkitBoxShadow=this.markerWrapper_.style.MozBoxShadow=this.getFlat()?"":this.getShadow()};RichMarker.prototype.flat_changed=RichMarker.prototype.flat_changed;RichMarker.prototype.setZIndex=function(a){this.set("zIndex",a)};RichMarker.prototype.setZIndex=RichMarker.prototype.setZIndex;RichMarker.prototype.getZIndex=function(){return(this.get("zIndex"))};RichMarker.prototype.getZIndex=RichMarker.prototype.getZIndex;RichMarker.prototype.zIndex_changed=function(){if(this.getZIndex()&&this.ready_){this.markerWrapper_.style.zIndex=this.getZIndex()}};RichMarker.prototype.zIndex_changed=RichMarker.prototype.zIndex_changed;RichMarker.prototype.getDraggable=function(){return(this.get("draggable"))};RichMarker.prototype.getDraggable=RichMarker.prototype.getDraggable;RichMarker.prototype.setDraggable=function(a){this.set("draggable",!!a)};RichMarker.prototype.setDraggable=RichMarker.prototype.setDraggable;RichMarker.prototype.draggable_changed=function(){if(this.ready_){if(this.getDraggable()){this.addDragging_(this.markerWrapper_)}else{this.removeDragListeners_()}}};RichMarker.prototype.draggable_changed=RichMarker.prototype.draggable_changed;RichMarker.prototype.getPosition=function(){return(this.get("position"))};RichMarker.prototype.getPosition=RichMarker.prototype.getPosition;RichMarker.prototype.setPosition=function(a){this.set("position",a)};RichMarker.prototype.setPosition=RichMarker.prototype.setPosition;RichMarker.prototype.position_changed=function(){this.draw()};RichMarker.prototype.position_changed=RichMarker.prototype.position_changed;RichMarker.prototype.getAnchor=function(){return(this.get("anchor"))};RichMarker.prototype.getAnchor=RichMarker.prototype.getAnchor;RichMarker.prototype.setAnchor=function(a){this.set("anchor",a)};RichMarker.prototype.setAnchor=RichMarker.prototype.setAnchor;RichMarker.prototype.anchor_changed=function(){this.draw()};RichMarker.prototype.anchor_changed=RichMarker.prototype.anchor_changed;RichMarker.prototype.htmlToDocumentFragment_=function(c){var b=document.createElement("DIV");b.innerHTML=c;if(b.childNodes.length==1){return(b.removeChild(b.firstChild))}else{var a=document.createDocumentFragment();while(b.firstChild){a.appendChild(b.firstChild)}return a}};RichMarker.prototype.removeChildren_=function(a){if(!a){return}var b;while(b=a.firstChild){a.removeChild(b)}};RichMarker.prototype.setContent=function(a){this.set("content",a)};RichMarker.prototype.setContent=RichMarker.prototype.setContent;RichMarker.prototype.getContent=function(){return(this.get("content"))};RichMarker.prototype.getContent=RichMarker.prototype.getContent;RichMarker.prototype.content_changed=function(){if(!this.markerContent_){return}this.removeChildren_(this.markerContent_);var d=this.getContent();if(d){if(typeof d=="string"){d=d.replace(/^\s*([\S\s]*)\b\s*$/,"$1");d=this.htmlToDocumentFragment_(d)}this.markerContent_.appendChild(d);var c=this;var a=this.markerContent_.getElementsByTagName("IMG");for(var b=0,e;e=a[b];b++){google.maps.event.addDomListener(e,"mousedown",function(f){if(c.getDraggable()){if(f.preventDefault){f.preventDefault()}f.returnValue=false}});google.maps.event.addDomListener(e,"load",function(){c.draw()})}google.maps.event.trigger(this,"domready")}if(this.ready_){this.draw()}};RichMarker.prototype.content_changed=RichMarker.prototype.content_changed;RichMarker.prototype.setCursor_=function(a){if(!this.ready_){return}var b="";if(navigator.userAgent.indexOf("Gecko/")!==-1){if(a=="dragging"){b="-moz-grabbing"}if(a=="dragready"){b="-moz-grab"}if(a=="draggable"){b="pointer"}}else{if(a=="dragging"||a=="dragready"){b="move"}if(a=="draggable"){b="pointer"}}if(this.markerWrapper_.style.cursor!=b){this.markerWrapper_.style.cursor=b}};RichMarker.prototype.startDrag=function(b){if(!this.getDraggable()){return}if(!this.dragging_){this.dragging_=true;var a=this.getMap();this.mapDraggable_=a.get("draggable");a.set("draggable",false);this.mouseX_=b.clientX;this.mouseY_=b.clientY;this.setCursor_("dragready");this.markerWrapper_.style.MozUserSelect="none";this.markerWrapper_.style.KhtmlUserSelect="none";this.markerWrapper_.style.WebkitUserSelect="none";this.markerWrapper_.unselectable="on";this.markerWrapper_.onselectstart=function(){return false};this.addDraggingListeners_();google.maps.event.trigger(this,"dragstart")}};RichMarker.prototype.stopDrag=function(){if(!this.getDraggable()){return}if(this.dragging_){this.dragging_=false;this.getMap().set("draggable",this.mapDraggable_);this.mouseX_=this.mouseY_=this.mapDraggable_=null;this.markerWrapper_.style.MozUserSelect="";this.markerWrapper_.style.KhtmlUserSelect="";this.markerWrapper_.style.WebkitUserSelect="";this.markerWrapper_.unselectable="off";this.markerWrapper_.onselectstart=function(){};this.removeDraggingListeners_();this.setCursor_("draggable");google.maps.event.trigger(this,"dragend");this.draw()}};RichMarker.prototype.drag=function(h){if(!this.getDraggable()||!this.dragging_){this.stopDrag();return}var d=this.mouseX_-h.clientX;var c=this.mouseY_-h.clientY;this.mouseX_=h.clientX;this.mouseY_=h.clientY;var g=parseInt(this.markerWrapper_.style.left,10)-d;var f=parseInt(this.markerWrapper_.style.top,10)-c;this.markerWrapper_.style.left=g+"px";this.markerWrapper_.style.top=f+"px";var j=this.getOffset_();var b=new google.maps.Point(g-j.width,f-j.height);var a=this.getProjection();this.setPosition(a.fromDivPixelToLatLng(b));this.setCursor_("dragging");google.maps.event.trigger(this,"drag")};RichMarker.prototype.removeDragListeners_=function(){if(this.draggableListener_){google.maps.event.removeListener(this.draggableListener_);delete this.draggableListener_}this.setCursor_("")};RichMarker.prototype.addDragging_=function(b){if(!b){return}var a=this;this.draggableListener_=google.maps.event.addDomListener(b,"mousedown",function(c){a.startDrag(c)});this.setCursor_("draggable")};RichMarker.prototype.addDraggingListeners_=function(){var a=this;if(this.markerWrapper_.setCapture){this.markerWrapper_.setCapture(true);this.draggingListeners_=[google.maps.event.addDomListener(this.markerWrapper_,"mousemove",function(b){a.drag(b)},true),google.maps.event.addDomListener(this.markerWrapper_,"mouseup",function(){a.stopDrag();a.markerWrapper_.releaseCapture()},true)]}else{this.draggingListeners_=[google.maps.event.addDomListener(window,"mousemove",function(b){a.drag(b)},true),google.maps.event.addDomListener(window,"mouseup",function(){a.stopDrag()},true)]}};RichMarker.prototype.removeDraggingListeners_=function(){if(this.draggingListeners_){for(var a=0,b;b=this.draggingListeners_[a];a++){google.maps.event.removeListener(b)}this.draggingListeners_.length=0}};RichMarker.prototype.getOffset_=function(){var b=this.getAnchor();if(typeof b=="object"){return(b)}var d=new google.maps.Size(0,0);if(!this.markerContent_){return d}var c=this.markerContent_.offsetWidth;var a=this.markerContent_.offsetHeight;switch(b){case RichMarkerPosition.TOP_LEFT:break;case RichMarkerPosition.TOP:d.width=-c/2;break;case RichMarkerPosition.TOP_RIGHT:d.width=-c;break;case RichMarkerPosition.LEFT:d.height=-a/2;break;case RichMarkerPosition.MIDDLE:d.width=-c/2;d.height=-a/2;break;case RichMarkerPosition.RIGHT:d.width=-c;d.height=-a/2;break;case RichMarkerPosition.BOTTOM_LEFT:d.height=-a;break;case RichMarkerPosition.BOTTOM:d.width=-c/2;d.height=-a;break;case RichMarkerPosition.BOTTOM_RIGHT:d.width=-c;d.height=-a;break}return d};RichMarker.prototype.onAdd=function(){if(!this.markerWrapper_){this.markerWrapper_=document.createElement("DIV");this.markerWrapper_.style.position="absolute"}if(this.getZIndex()){this.markerWrapper_.style.zIndex=this.getZIndex()}this.markerWrapper_.style.display=this.getVisible()?"":"none";if(!this.markerContent_){this.markerContent_=document.createElement("DIV");this.markerWrapper_.appendChild(this.markerContent_);var b=this;google.maps.event.addDomListener(this.markerContent_,"click",function(c){google.maps.event.trigger(b,"click")});google.maps.event.addDomListener(this.markerContent_,"mouseover",function(c){google.maps.event.trigger(b,"mouseover")});google.maps.event.addDomListener(this.markerContent_,"mouseout",function(c){google.maps.event.trigger(b,"mouseout")})}this.ready_=true;this.content_changed();this.flat_changed();this.draggable_changed();var a=this.getPanes();if(a){a.overlayMouseTarget.appendChild(this.markerWrapper_)}google.maps.event.trigger(this,"ready")};RichMarker.prototype.onAdd=RichMarker.prototype.onAdd;RichMarker.prototype.draw=function(){if(!this.ready_||this.dragging_){return}var b=this.getProjection();if(!b){return}var d=(this.get("position"));var f=b.fromLatLngToDivPixel(d);var e=this.getOffset_();this.markerWrapper_.style.top=(f.y+e.height)+"px";this.markerWrapper_.style.left=(f.x+e.width)+"px";var a=this.markerContent_.offsetHeight;var c=this.markerContent_.offsetWidth;if(c!=this.get("width")){this.set("width",c)}if(a!=this.get("height")){this.set("height",a)}};RichMarker.prototype.draw=RichMarker.prototype.draw;RichMarker.prototype.onRemove=function(){if(this.markerWrapper_&&this.markerWrapper_.parentNode){this.markerWrapper_.parentNode.removeChild(this.markerWrapper_)}this.removeDragListeners_()};RichMarker.prototype.onRemove=RichMarker.prototype.onRemove;var RichMarkerPosition={TOP_LEFT:1,TOP:2,TOP_RIGHT:3,LEFT:4,MIDDLE:5,RIGHT:6,BOTTOM_LEFT:7,BOTTOM:8,BOTTOM_RIGHT:9};window.RichMarkerPosition=RichMarkerPosition;function itemTemplate(b){var a=[];a.push('<div class="col bus-item " data-bus-id="'+b["@attributes"]["BUS_ID"]+'">');a.push('<div class="bus-inner-wrap">');a.push('<div class="item-body">');a.push('<div class="items-info">');a.push('<div class="  line-no">');a.push("<div>"+b["@attributes"]["ROUTE_NAME"]+"</div>");a.push("</div>");a.push("<hr/>");a.push('<div class="  name">');a.push("<div>"+b["@attributes"]["DRIVER_NAME"]+"</div>");a.push("<div>"+b["@attributes"]["PLATE"]+"</div>");a.push("</div>");a.push("</div>");a.push('<div class="thumbnail">');a.push('<img class="img-responsive" src="/assets/images/'+(b["@attributes"]["BUS_MODEL"]?b["@attributes"]["BUS_MODEL"]:(b["@attributes"]["DISPLAY_ROUTE_CODE"]=="H1"?"NEOPLAN":"CREALIS"))+'.jpg" alt="">');a.push("</div>");a.push('<div class="items-info ">');a.push('<div class="bus-stop">');a.push("<div>");splited=b["@attributes"]["PREV_STOP"].substr(b["@attributes"]["PREV_STOP"].indexOf(" ")+1);a.push("<div><b>Cari : </b>"+splited+"</div>");delete splited;splited=b["@attributes"]["CURRENT_STOP"].substr(b["@attributes"]["CURRENT_STOP"].indexOf(" ")+1);a.push("<div><b>Növbəti : </b>"+splited+"</div>");delete splited;a.push("</div>");a.push("</div>");a.push('<div class="clearfix"></div>');a.push("</div>");a.push('<div class="clearfix"></div>');a.push("</div>");a.push("</div>");a.push("</div>");return a}function clearMarkers(){for(var b=0,a;a=profileMarkers[b];b++){a.richmarker.setMap(null);a.setMap(null)}profileMarkers=[]}function clearMarkers(c){for(var b=0,a;a=c[b];b++){a.richmarker.setMap(null);a.setMap(null)}c=[]}function addMarkers(b){var a=0;$.each(b.BUS,function(e,g){bus_id=g["@attributes"]["BUS_ID"];routeCode=g["@attributes"]["DISPLAY_ROUTE_CODE"];if((!!activeRoutes&&$.inArray(routeCode,activeRoutes)==-1)||(activeRoute!==null&&activeRoute!=routeCode)){if(resultsArray[bus_id]!==undefined&&resultsArray[bus_id].marker!==undefined){resultsArray[bus_id].marker.setMap(null)}return}posTmp=new google.maps.LatLng(parseFloat(g["@attributes"]["LATITUDE"].replace(/\,/g,".")),parseFloat(g["@attributes"]["LONGITUDE"].replace(/\,/g,".")));if(resultsArray[bus_id]!==undefined){resultsArray[bus_id].marker.setPosition(posTmp);if(resultsArray[bus_id].marker.getMap()==null){resultsArray[bus_id].marker.setMap(map)}resultsArray[bus_id].marker.richmarker.position=posTmp;delete posTmp;delete bus_id;a++;return}richBox=itemTemplate(g);var f=new RichMarker({map:map,position:posTmp,content:richBox.join(""),visible:false,draggable:false,flat:true});resultsArray[bus_id]=g;var c=new google.maps.Marker({map:map,position:posTmp,icon:new google.maps.MarkerImage("/az/ajax/marker/?text="+g["@attributes"]["DISPLAY_ROUTE_CODE"],null,null,null,new google.maps.Size(20,20)),zIndex:25,animation:google.maps.Animation.DROP,fillColor:"#ff0000",richmarker:f,listId:e,model:g,id:bus_id});profileMarkers.push(c);resultsArray[c.id].marker=c;google.maps.event.addListener(c,"click",function(){});google.maps.event.addListener(c,"mouseover",function(){this.richmarker.setVisible(1);$(".items-list .items-container .elan[data-elan-id="+this.id+"]").addClass("active")});google.maps.event.addListener(c,"mouseout",function(){this.richmarker.setVisible(0)})});console.log("Stat:"+a);console.log("Array count:"+profileMarkers.length)}function rad(a){return a*Math.PI/180}function find_closest_marker(b){var m=b.latLng.lat();var n=b.latLng.lng();var h=6371;var o=[];var e=-1;for(i=0;i<map.markers.length;i++){var f=map.markers[i].position.lat();var g=map.markers[i].position.lng();var k=rad(f-m);var q=rad(g-n);var p=Math.sin(k/2)*Math.sin(k/2)+Math.cos(rad(m))*Math.cos(rad(m))*Math.sin(q/2)*Math.sin(q/2);var l=2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p));var j=h*l;o[i]=j;if(e==-1||j<o[e]){e=i}}alert(map.markers[e].title)}function calculateAndDisplayRoute(e,c,d,b){var a=[];var f=document.getElementById("waypoints");e.route({origin:d[0].latitude+","+d[0].longitude,destination:d[d.length-1].latitude+","+d[d.length-1].longitude,optimizeWaypoints:true,travelMode:google.maps.TravelMode.WALKING,},function(j,g){if(g===google.maps.DirectionsStatus.OK){c.setDirections(j);var h=j.routes[0]}else{window.alert("Directions request failed due to "+g)}})}var busstopsMarker=new Array();function renderPath(e,c,j,b){var a=new Array(),f=new google.maps.InfoWindow();var k=new google.maps.LatLngBounds();for(i=0;i<e.length;i++){var h=e[i];var d=new google.maps.LatLng(h.latitude.replace(/\,/g,"."),h.longitude.replace(/\,/g,"."));a.push(d);var g=new google.maps.Marker({position:d,map:map,icon:(i==0?new google.maps.MarkerImage("/assets/images/bakubus-marker2.png",null,null,null,new google.maps.Size(30,30)):(i==e.length-1?new google.maps.MarkerImage("/assets/images/a-marker.png",null,null,null,new google.maps.Size(30,30)):new google.maps.MarkerImage("/assets/images/busstop.png",null,null,null,new google.maps.Size(30,30)))),title:h.name,zIndex:5});k.extend(g.position);(function(l,m){google.maps.event.addListener(l,"click",function(n){f.setContent(l.title);f.open(map,l)})})(g,h);busstopsMarker.push(g)}map.setCenter(k.getCenter());map.fitBounds(k);kml=new google.maps.KmlLayer({url:"http://www.bakubus.az/az/ajax/getPathKml/"+b,map:map});poly.push(kml)}function countBusesByRoute(a){var b=0;$.each(resultsArray,function(c,e){bus_id=e["@attributes"]["BUS_ID"];if(e["@attributes"]["DISPLAY_ROUTE_CODE"]==a){b++}});return b}function project(b){var a=Math.sin(b.lat()*Math.PI/180);a=Math.min(Math.max(a,-0.9999),0.9999);return new google.maps.Point(TILE_SIZE*(0.5+b.lng()/360),TILE_SIZE*(0.5-Math.log((1+a)/(1-a))/(4*Math.PI)))}function latLngTopixels(d,c){var f=1<<c;var a=project(d);var b=new google.maps.Point(Math.floor(a.x*f),Math.floor(a.y*f));var e=new google.maps.Point(Math.floor(a.x*f/TILE_SIZE),Math.floor(a.y*f/TILE_SIZE));return e};